\section{Part 2: Tax allowance}
\label{sec:3_part_two}

The second part of the project introduces an income tax allowance system. It states that every taxpayer has a standard tax allowance of 5000. Married couples are able to swap their allowance freely. In the standard implementation, every taxpayer has access to the public function transferAllowance(). It deducts an arbitrary value from its own tax allowance and adds it to the allowance of its spouse.

%-------------------------------------------------------------------------
\subsection{Invariants}

The Echidna properties for this subtask were designed to address four problems. Firstly, the allowance of an unmarried individual younger than 65 that hasn't won a lottery must be exactly 5000. Secondly, unmarried taxpayers under 65 that have won the lottery at some point must have an allowance of exactly 7000. Third, the allowance of a taxpayer must never go below zero. Fourth, the combined allowance of married couples must either be 10000, 12000 or 14000 to account for lottery wins.

\noindent
\begin{minipage}{\linewidth}
  \lstinputlisting[ language=Solidity, firstline=76, lastline=81, caption={Invariant to monitor the default tax allowance in Taxpayer.sol}, label={lst:tax-allowance-default} ]{../../echidna.sol}
\end{minipage}

\noindent
\begin{minipage}{\linewidth}
  \lstinputlisting[ language=Solidity, firstline=86, lastline=91, caption={Invariant to monitor the extended tax allowance in Taxpayer.sol}, label={lst:tax-allowance-default} ]{../../echidna.sol}
\end{minipage}

\noindent
\begin{minipage}{\linewidth}
  \lstinputlisting[ language=Solidity, firstline=96, lastline=98, caption={Invariant to monitor that tax allowance never goes below zero in Taxpayer.sol}, label={lst:tax-allowance-default} ]{../../echidna.sol}
\end{minipage}

\noindent
\begin{minipage}{\linewidth}
  \lstinputlisting[ language=Solidity, firstline=103, lastline=110, caption={Invariant to monitors the combined tax allowance of married couples in Taxpayer.sol}, label={lst:tax-allowance-default} ]{../../echidna.sol}
\end{minipage}

%-------------------------------------------------------------------------
\subsection{Code improvements}

An important factor in fulfilling the invariants defined above lies in the function visibility. By the given default, not only is transferAllowance() public, but also the setter function setTaxAllowance(). This allows for the tax allowance to be set to an arbitrary number by anyone. A naive approach to this problem is to set all variables and functions related to a Taxpayers tax allowance to private. This creates a new problem, because it is then no longer possible to control the tax allowance of the spouse in the case of married couples.

The solution presented in this report splits the transferAllowance() function into two parts: transferAllowance() and receiveAllowance().

\noindent
\begin{minipage}{\linewidth}
  \lstinputlisting[ language=Solidity, firstline=100, lastline=107, caption={Function to send allowance to spouse in Taxpayer.sol}, label={lst:send-tax-allowance} ]{../../Taxpayer.sol}
\end{minipage}

The improved transferAllowance() function as shown in Listing \ref{lst:send-tax-allowance} checks several preconditions. It ensures that the Taxpayer is married and has a positive allowance of at least the desired change amount. If that is the case, it deducts the transferred allowance from its own account and triggers a call of the receiveAllowance() function of the spouse object.

\noindent
\begin{minipage}{\linewidth}
  \lstinputlisting[ language=Solidity, firstline=114, lastline=118, caption={Function to receive allowance from spouse Taxpayer.sol}, label={lst:receive-tax-allowance} ]{../../Taxpayer.sol}
\end{minipage}

The receiveAllowance() (shown in Listing \ref{lst:receive-tax-allowance}) function is declared as "external" in order to prevent the taxpayer from increasing its allowance one its own. To increase the access to control, it also checks the marital status of the executing Taxpayer and ensures that only the defined spouse is allowed to receive allowance. If the conditions are met, the private addTaxAllowance() (Listing \ref{lst:add-tax-allowance}) function is called.

\noindent
\begin{minipage}{\linewidth}
  \lstinputlisting[ language=Solidity, firstline=136, lastline=138, caption={Function to change allowance in Taxpayer.sol}, label={lst:add-tax-allowance} ]{../../Taxpayer.sol}
\end{minipage}

Even though the talked about security improvements prevent Echidna from breaking the invariants, it must be noted that real malicious actors are still able to abuse the system at hand. One major attack vector is the check for valid spouse addresses (function shown in Listing \ref{lst:address-validation}). It is possible to craft a malicious taxpayer contract that implements the isContract() function in the same way as the original, but with malicious calls to e.g. receiveAllowance() or other functions. Furthermore, all public functions of a taxpayer instance can currently be called by anyone with the address of the taxpayer object. For a real production deployment, it would be necessary to only grant access to the original owner of the contract. These blind spots are created by the nature of Echidna fuzzing tests. On one hand, Echidna will not create entire malicious code classes to break invariants, but instead it resorts to calling the (helper) functions with various inputs. To
simulate the mentioned attack vectors with Echidna, extensive scaffolding of malicious code with helper functions for Echidna are needed. For the purposes of this task, these security considerations were also deemed out-of-scope.